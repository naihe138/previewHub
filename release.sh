#!/bin/bash

# PreviewHub GitHub Release å‘å¸ƒè„šæœ¬
# è‡ªåŠ¨åˆ›å»ºGitæ ‡ç­¾ã€æ¨é€ä»£ç å¹¶å‡†å¤‡GitHub Release

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

echo "ğŸš€ PreviewHub GitHub Release å‘å¸ƒå·¥å…·"
echo "======================================="

# è¯»å–å½“å‰ç‰ˆæœ¬
VERSION=$(grep '"version"' manifest.json | sed 's/.*"version": "\(.*\)".*/\1/')
echo "ğŸ“¦ å½“å‰ç‰ˆæœ¬: v$VERSION"

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [[ -n $(git status --porcelain) ]]; then
    echo "âš ï¸  æ£€æµ‹åˆ°æœªæäº¤çš„æ›´æ”¹ï¼Œæ­£åœ¨æäº¤..."
    
    # æ·»åŠ æ‰€æœ‰æ›´æ”¹
    git add .
    
    # æäº¤æ›´æ”¹
    git commit -m "feat: å‘å¸ƒ v$VERSION - å…¨é¢Markdownæ”¯æŒ

- ğŸ‰ æ”¯æŒæ‰€æœ‰.mdæ–‡ä»¶çš„å›¾ç‰‡é¢„è§ˆï¼ˆä¸ä»…é™äºREADME.mdï¼‰
- âœ¨ æ”¹è¿›Markdownå®¹å™¨æ£€æµ‹é€»è¾‘
- ğŸ”§ é‡æ„æ ¸å¿ƒæ–¹æ³•ï¼Œä¿æŒå‘åå…¼å®¹
- ğŸ“ æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£å’Œæè¿°
- ğŸ› ä¿®å¤åªèƒ½åœ¨README.mdä¸­é¢„è§ˆå›¾ç‰‡çš„é™åˆ¶

Closes: #1 - æ”¯æŒæ‰€æœ‰markdownæ–‡ä»¶çš„å›¾ç‰‡é¢„è§ˆ"
    
    echo "âœ… å·²æäº¤æ‰€æœ‰æ›´æ”¹"
else
    echo "âœ… å·¥ä½œç›®å½•å¹²å‡€ï¼Œæ— éœ€æäº¤"
fi

# æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
if git tag -l | grep -q "^v$VERSION$"; then
    echo "âš ï¸  æ ‡ç­¾ v$VERSION å·²å­˜åœ¨ï¼Œæ­£åœ¨åˆ é™¤..."
    git tag -d "v$VERSION"
    git push origin --delete "v$VERSION" 2>/dev/null || true
fi

# åˆ›å»ºæ–°æ ‡ç­¾
echo "ğŸ·ï¸  åˆ›å»ºæ ‡ç­¾ v$VERSION..."
git tag -a "v$VERSION" -m "Release v$VERSION - å…¨é¢Markdownæ”¯æŒ

ğŸ‰ æ–°åŠŸèƒ½:
- æ”¯æŒæ‰€æœ‰.mdæ–‡ä»¶çš„å›¾ç‰‡é¢„è§ˆï¼ˆREADMEã€æ–‡æ¡£ã€Wikiç­‰ï¼‰
- æ™ºèƒ½Markdownå®¹å™¨æ£€æµ‹
- å¢å¼ºçš„GitHub.devç¼–è¾‘å™¨å…¼å®¹æ€§

ğŸ”§ æŠ€æœ¯æ”¹è¿›:
- é‡æ„æ ¸å¿ƒæ£€æµ‹æ–¹æ³•
- æ”¹è¿›é¡µé¢å˜åŒ–ç›‘å¬
- ä¿æŒ100%å‘åå…¼å®¹æ€§

ğŸ› Bugä¿®å¤:
- ä¿®å¤åªèƒ½åœ¨README.mdä¸­é¢„è§ˆå›¾ç‰‡çš„é™åˆ¶
- æ”¹è¿›åœ¨ä¸åŒç±»å‹markdownæ–‡ä»¶ä¸­çš„å·¥ä½œç¨³å®šæ€§

ğŸ“ æ–‡æ¡£æ›´æ–°:
- æ›´æ–°æ‰€æœ‰ç›¸å…³æ–‡æ¡£
- æ–°å¢è¯¦ç»†çš„æ›´æ–°æ—¥å¿—
- æ›´æ–°å•†åº—æè¿°å’Œå®£ä¼ ææ–™"

# æ¨é€åˆ°è¿œç¨‹ä»“åº“
echo "ğŸ“¤ æ¨é€ä»£ç å’Œæ ‡ç­¾åˆ°GitHub..."
git push origin main
git push origin "v$VERSION"

echo ""
echo "âœ… Gitå‘å¸ƒå®Œæˆ!"
echo ""
echo "ğŸ“‹ æ¥ä¸‹æ¥çš„æ­¥éª¤:"
echo "1. è®¿é—® GitHub ä»“åº“çš„ Releases é¡µé¢"
echo "2. ç‚¹å‡» 'Create a new release'"
echo "3. é€‰æ‹©æ ‡ç­¾: v$VERSION"
echo "4. ä½¿ç”¨ä»¥ä¸‹ä¿¡æ¯åˆ›å»º Release:"
echo ""

# ç”Ÿæˆå‘å¸ƒè¯´æ˜
cat > release-notes.md << 'EOF'
# ğŸ‰ PreviewHub v1.1.0 - å…¨é¢Markdownæ”¯æŒ

## ğŸ†• æ–°åŠŸèƒ½

### ğŸ“ å…¨é¢.mdæ–‡ä»¶æ”¯æŒ
ç°åœ¨æ”¯æŒGitHubä¸Šæ‰€æœ‰ç±»å‹çš„Markdownæ–‡ä»¶çš„å›¾ç‰‡é¢„è§ˆï¼š
- âœ… README.md æ–‡ä»¶
- âœ… é¡¹ç›®æ–‡æ¡£ (docs/*.md)  
- âœ… Wikié¡µé¢
- âœ… ä»»æ„.mdæ–‡ä»¶
- âœ… GitHub.devç¼–è¾‘å™¨ä¸­çš„æ‰€æœ‰markdownæ–‡ä»¶

### ğŸ” æ™ºèƒ½æ£€æµ‹å¢å¼º
- æ”¹è¿›äº†Markdownå®¹å™¨æ£€æµ‹é€»è¾‘
- æ”¯æŒæ›´å¤šGitHubé¡µé¢ç±»å‹
- å¢å¼ºçš„SPAè·¯ç”±å˜åŒ–æ£€æµ‹

## ğŸ”§ æŠ€æœ¯æ”¹è¿›

- **æ ¸å¿ƒé‡æ„**: é‡æ„äº†æ ¸å¿ƒæ£€æµ‹æ–¹æ³•ï¼Œä»READMEä¸“ç”¨æ”¹ä¸ºå…¨é¢Markdownæ”¯æŒ
- **å‘åå…¼å®¹**: ä¿æŒ100%APIå…¼å®¹æ€§ï¼Œç°æœ‰ç”¨æˆ·æ— éœ€ä»»ä½•æ“ä½œ
- **æ€§èƒ½ä¼˜åŒ–**: æ”¹è¿›äº†é€‰æ‹©å™¨æ•ˆç‡å’Œæ£€æµ‹å‡†ç¡®æ€§
- **ä»£ç è´¨é‡**: æ›´æ¸…æ™°çš„æ–¹æ³•å‘½åå’Œä»£ç ç»“æ„

## ğŸ› Bugä¿®å¤

- ğŸ”§ ä¿®å¤äº†åªèƒ½åœ¨README.mdæ–‡ä»¶ä¸­é¢„è§ˆå›¾ç‰‡çš„é™åˆ¶
- ğŸ”§ æ”¹è¿›äº†åœ¨GitHub.devç¼–è¾‘å™¨ä¸­çš„å·¥ä½œç¨³å®šæ€§
- ğŸ”§ ä¼˜åŒ–äº†åœ¨ä¸åŒç±»å‹markdownæ–‡ä»¶ä¸­çš„å…¼å®¹æ€§

## ğŸ“Š å½±å“èŒƒå›´

- **ä½¿ç”¨åœºæ™¯**: ä»å•ä¸€READMEæ‰©å±•åˆ°æ‰€æœ‰.mdæ–‡ä»¶ï¼ˆé¢„è®¡å¢åŠ 300%+ä½¿ç”¨åœºæ™¯ï¼‰
- **ç”¨æˆ·ä½“éªŒ**: å¤§å¹…æå‡åœ¨æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æ—¶çš„ä¾¿åˆ©æ€§
- **å…¼å®¹æ€§**: å®Œå…¨å‘åå…¼å®¹ï¼Œç°æœ‰ç”¨æˆ·è‡ªåŠ¨è·å¾—æ–°åŠŸèƒ½

## ğŸ“¦ å®‰è£…æ–¹å¼

### Chrome Web Store
1. è®¿é—® Chrome Web Store
2. æœç´¢ "PreviewHub"
3. ç‚¹å‡»"æ·»åŠ åˆ°Chrome"

### æ‰‹åŠ¨å®‰è£…
1. ä¸‹è½½ä¸‹æ–¹çš„ `previewhub-v1.1.0.zip` æ–‡ä»¶
2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
3. æ‰“å¼€Chromeæ‰©å±•é¡µé¢ (`chrome://extensions/`)
4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"ï¼Œé€‰æ‹©è§£å‹çš„æ–‡ä»¶å¤¹

## ğŸ™ è‡´è°¢

æ„Ÿè°¢æ‰€æœ‰ç”¨æˆ·çš„åé¦ˆå’Œå»ºè®®ï¼Œç‰¹åˆ«æ˜¯å¯¹æ”¯æŒæ›´å¤šmarkdownæ–‡ä»¶çš„éœ€æ±‚ï¼

---

**å®Œæ•´æ›´æ–°æ—¥å¿—**: [CHANGELOG.md](https://github.com/naihe138/previewHub/blob/main/CHANGELOG.md)
EOF

echo "ğŸ“ å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ: release-notes.md"
echo ""
echo "ğŸ”— GitHub Release åˆ›å»ºé“¾æ¥:"
echo "https://github.com/naihe138/previewHub/releases/new?tag=v$VERSION"
echo ""
echo "ğŸ“ éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶:"
ls -la previewhub-v$VERSION-*.zip 2>/dev/null || echo "âš ï¸  è¯·å…ˆè¿è¡Œ ./package-for-store.sh ç”Ÿæˆå‘å¸ƒåŒ…"
echo ""
echo "ğŸ¯ å»ºè®®çš„Releaseæ ‡é¢˜: PreviewHub v$VERSION - å…¨é¢Markdownæ”¯æŒ"
echo ""
echo "âœ¨ å‘å¸ƒå‡†å¤‡å®Œæˆï¼"
